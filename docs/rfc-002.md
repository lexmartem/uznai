# RFC-002: User Authentication & Profile

## Summary
This RFC covers the implementation of user authentication, authorization, and basic profile management for the Uznai quiz platform. It builds upon the infrastructure established in RFC-001 to provide a secure system for user registration, login, session management, and profile creation/viewing.

## Features Addressed
- F1: User Registration
- F2: User Login
- F3: Role-Based Access
- F4: Password Reset
- F5: Session Management
- F20: Profile Creation

## Technical Approach

### Authentication System
1. Implement JWT-based authentication:
   - Generate JWT tokens upon successful login
   - Include user ID and roles in token claims
   - Configure token expiration and refresh mechanisms
   - Implement secure token storage on the client-side

2. Implement user registration functionality:
   - Form for collecting user details (username, email, password)
   - Email validation with regex
   - Password strength validation
   - Duplicate email/username checking
   - BCrypt password hashing

3. Implement login functionality:
   - Login form with username/email and password
   - Authentication failure handling
   - JWT token generation and delivery
   - Remember me option for extended sessions

4. Implement password reset functionality:
   - Forgot password form
   - Secure token generation for password reset
   - Email notification (simulated in development)
   - Password reset form with token validation

### Role-Based Authorization
1. Configure Spring Security with role-based access:
   - Define USER and PREMIUM_USER roles
   - Set up method-level security with @PreAuthorize
   - Configure security for REST endpoints
   - Implement custom UserDetailsService

2. Implement role assignment logic:
   - Assign USER role by default at registration
   - Create mechanism for role upgrade (to be used in later RFCs)

### Session Management
1. Implement secure session handling:
   - JWT token validation on protected routes
   - Token refresh mechanism
   - Logout functionality (token invalidation)
   - Cross-device session management

### Profile Management
1. Implement basic user profile functionality:
   - Profile view with user details
   - Profile edit functionality
   - Username and email update capabilities
   - Password change functionality

## API Contracts

### Authentication Endpoints

#### Register User
```
POST /api/v1/auth/register
Request:
{
  "username": "string",
  "email": "string",
  "password": "string"
}
Response:
{
  "id": "UUID",
  "username": "string",
  "email": "string",
  "created_at": "date-time"
}
Status: 201 Created
```

#### Login
```
POST /api/v1/auth/login
Request:
{
  "username": "string",
  "password": "string",
  "remember_me": "boolean"
}
Response:
{
  "token": "string",
  "refresh_token": "string",
  "expires_in": "number",
  "user": {
    "id": "UUID",
    "username": "string",
    "email": "string",
    "roles": ["string"]
  }
}
Status: 200 OK
```

#### Refresh Token
```
POST /api/v1/auth/refresh
Request:
{
  "refresh_token": "string"
}
Response:
{
  "token": "string",
  "refresh_token": "string",
  "expires_in": "number"
}
Status: 200 OK
```

#### Logout
```
POST /api/v1/auth/logout
Request: {}
Response: {}
Status: 204 No Content
```

#### Forgot Password
```
POST /api/v1/auth/forgot-password
Request:
{
  "email": "string"
}
Response: {}
Status: 204 No Content
```

#### Reset Password
```
POST /api/v1/auth/reset-password
Request:
{
  "token": "string",
  "password": "string"
}
Response: {}
Status: 204 No Content
```

### Profile Endpoints

#### Get Current User Profile
```
GET /api/v1/users/me
Response:
{
  "id": "UUID",
  "username": "string",
  "email": "string",
  "created_at": "date-time",
  "roles": ["string"]
}
Status: 200 OK
```

#### Update User Profile
```
PUT /api/v1/users/me
Request:
{
  "username": "string",
  "email": "string"
}
Response:
{
  "id": "UUID",
  "username": "string",
  "email": "string",
  "created_at": "date-time",
  "updated_at": "date-time"
}
Status: 200 OK
```

#### Change Password
```
PUT /api/v1/users/me/password
Request:
{
  "current_password": "string",
  "new_password": "string"
}
Response: {}
Status: 204 No Content
```

## Database Changes

### Password Reset Tokens Table
```
password_reset_tokens (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  token VARCHAR(255) NOT NULL UNIQUE,
  expiration_date TIMESTAMP NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
)
```

### User Profile Information (Add to Users Table)
```
ALTER TABLE users ADD COLUMN bio TEXT;
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255);
```

## File Structure

### Backend Additions
```
com.uznai/
├── config/
│   └── JwtConfig.java                 # JWT configuration
├── controller/
│   ├── AuthController.java            # Authentication endpoints
│   └── UserController.java            # User profile endpoints
├── dto/
│   ├── request/
│   │   ├── LoginRequest.java
│   │   ├── RegisterRequest.java
│   │   ├── PasswordResetRequest.java
│   │   ├── ForgotPasswordRequest.java
│   │   ├── RefreshTokenRequest.java
│   │   └── UpdateProfileRequest.java
│   └── response/
│       ├── JwtResponse.java
│       └── UserResponse.java
├── service/
│   ├── impl/
│   │   ├── AuthServiceImpl.java
│   │   ├── UserServiceImpl.java
│   │   └── JwtServiceImpl.java
│   ├── AuthService.java
│   ├── UserService.java
│   └── JwtService.java
├── security/
│   ├── JwtAuthenticationFilter.java
│   ├── JwtTokenProvider.java
│   └── UserDetailsServiceImpl.java
└── repository/
    └── PasswordResetTokenRepository.java
```

### Frontend Additions
```
src/
├── app/
│   ├── auth/
│   │   ├── login/page.tsx
│   │   ├── register/page.tsx
│   │   ├── forgot-password/page.tsx
│   │   └── reset-password/[token]/page.tsx
│   └── profile/page.tsx
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx
│   │   ├── RegisterForm.tsx
│   │   ├── ForgotPasswordForm.tsx
│   │   └── ResetPasswordForm.tsx
│   └── profile/
│       ├── ProfileView.tsx
│       └── ProfileEditForm.tsx
├── contexts/
│   └── AuthContext.tsx
├── hooks/
│   └── useAuth.ts
├── services/
│   └── auth-service.ts
└── types/
    └── auth.ts
```

## Implementation Considerations

### Technical Challenges
- Implementing secure JWT authentication with proper signature verification
- Handling token refresh without compromising security
- Ensuring proper password hashing and security measures
- Managing cross-device sessions effectively

### Performance Considerations
- JWT token size optimization to reduce overhead
- Efficient validation of tokens for each request
- Caching user information to reduce database queries

### Security Considerations
- Password stored using BCrypt hashing (no plaintext storage)
- Protection against brute force attacks
- CSRF protection for authentication endpoints
- XSS protection when storing tokens client-side
- Rate limiting for login attempts
- Secure password reset flow

### Edge Cases
- Handling expired tokens gracefully
- Dealing with password reset for non-existent users (security)
- Multiple concurrent login attempts
- Cross-device logout synchronization
- Email address changes requiring verification

### Testing Strategy
- Unit tests for authentication services
- Integration tests for authentication flow
- Unit tests for JWT token generation and validation
- Security tests for password hashing
- Integration tests for user profile management

## Acceptance Criteria

1. User Registration:
   - Users can successfully register with valid credentials
   - Duplicate usernames/emails are rejected
   - Passwords must meet strength requirements
   - Users receive appropriate feedback for validation errors

2. User Login:
   - Users can log in with valid credentials
   - Users receive a JWT token upon successful login
   - Invalid login attempts display appropriate error messages
   - Remember me functionality extends token lifetime

3. Session Management:
   - JWT tokens are validated on protected routes
   - Expired tokens are handled gracefully
   - Users can successfully log out
   - Token refresh works correctly

4. Password Reset:
   - Users can request password reset via email
   - Password reset tokens expire after a set time
   - Users can reset passwords with valid tokens
   - Invalid/expired tokens are rejected

5. Role-Based Access:
   - New users are assigned the USER role by default
   - Access to endpoints is properly restricted based on roles
   - Role information is properly included in JWT tokens

6. Profile Management:
   - Users can view their profile information
   - Users can update profile details
   - Users can change their password when authenticated

## Previous RFCs
- RFC-001: Project Setup & Infrastructure (provides the foundation for this RFC)

## Future RFCs
- RFC-003: Quiz Creation & Management (will use the authentication system)
- All subsequent RFCs will utilize the authentication system and user profiles

## Complexity
Medium

## Timeline Estimate
1-2 weeks
